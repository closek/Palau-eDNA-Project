---
title: "PalaueDNA_Nov2021"
author: "Collin J. Closek"
date: "2022-10-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load required packages 
```{r }
#install.packages("tidyverse")
#install.packages("vegan")
#install.packages("devtools")
#devtools::install_github("rlbarter/superheat")
#install.packages("here")
library(tidyverse)
library(tidyr)
library(ggplot2)
library(dplyr)
library(vegan)
library(data.table)
library(superheat)
library(here)
```

##Load data
```{r}
#esv_data_all <- (read.delim("./data/JVB1710-MiFishU-read-data.csv", sep=",", check.names=FALSE, header = TRUE))

esv_data_all <- read.csv(here("data/JVB1710-MiFishU-read-data.csv"),header = TRUE)

head (esv_data_all)
#glimpse (esv_data_all)
```

##Remove preliminary run (i.e., remove duplicated samples "S046...1" that have newer ".2" version) & cleanup columns
```{r}
data <- select(esv_data_all,-c(S046420.1, S046419.1, S046417.1, S046416.1, S046415.1, S046414.1, X))
data <- data %>%
  rename(
    Match_percent=X..match,
    Species_number=X..species
  ) 

#glimpse(data)
```


##Cobine header row cells into one 
Takes the following row headers: "TestId", "ESVId", "sequence", "Kingdom",  "Phylum", "Class", "Order", "Family", "Genus", "Species", "% match", "# species"
Merges them into one "MergedID" with the separator ","
```{r}
#esv_data_all_mergedrows <- unite(esv_data_all, col='MergedID', c('TestId', 'ESVId', 'sequence', 'Kingdom', 'Phylum', 'Class', 'Order', 'Family', 'Genus', 'Species', '% match', '# species'), sep=',')
```

## OLD - Create long data version 
```{r}
#esv_data_all_long <-
  esv_data_all %>%
  # rename columns with special characters of % and #
  rename(
    Match_percent=X..match,
    Species_number=X..species
  ) %>%
  select(-X) %>% # removes weird column that had blank information
  pivot_longer(
    "S049508.1":"S049391.0",
    names_to = "sample",
    values_to = "obs"
  )
```

##Create long data version
```{r}
data_long <-
  data %>%
  pivot_longer(
    "S049508.1":"S049391.0",
    names_to = "sample",
    values_to = "obs"
  )

#glimpse(data_long)
```



##Bring in samples key & merge with long data
```{r}
samples <- read.csv(here("data/JVB1710-samples_rv2.csv"),header=TRUE)
glimpse(samples)

left_joined <- merge(data_long, samples, by = "sample")
#glimpse(left_joined)
```

##Create full sample ID - merge original Sample name w/ the JV sample version name
```{r}
left_joined_unite <- left_joined %>%
  unite(col="ID_v", ClientSampleId, sample, sep= "-", 
        remove = TRUE)

#glimpse(left_joined_unite)
```

##Bring data frame back into Wide Format
```{r}
esv_read_data <- 
  left_joined_unite %>% 
  pivot_wider(
    names_from = "ID_v", 
    values_from = "obs"
  )

write.csv(esv_read_data, file = "/Users/closek/Documents/Nov2021_PalaueDNA/R/products/esv_read_data_rv.csv")
```

##Create Nearshore & Offshore dataframes
```{r}
offshore_esv <- esv_read_data %>% select(2, 8, 9, 10, contains('COS'), contains('AFZ'), contains('DFZ'), contains('NMS'))

nearshore_esv <- esv_read_data %>% select(2, 8, 9, 10, contains('COS'), contains('SHR'), contains('LGN'), contains('FRR'))

write.csv(offshore_esv, file = "/Users/closek/Documents/Nov2021_PalaueDNA/R/products/offshore_esv.csv")
write.csv(nearshore_esv, file = "/Users/closek/Documents/Nov2021_PalaueDNA/R/products/nearshore_esv.csv")
```

##Create Nearshore & Offshore species lists
```{r}
offshore_esv_sp <- esv_read_data %>% select(2, 10, contains('COS'), contains('AFZ'), contains('DFZ'), contains('NMS'))

nearshore_esv_sp <- esv_read_data %>% select(2, 10, contains('COS'), contains('SHR'), contains('LGN'), contains('FRR'))

write.csv(offshore_esv_sp, file = "/Users/closek/Documents/Nov2021_PalaueDNA/R/products/offshore_esv_sp.csv")
write.csv(nearshore_esv_sp, file = "/Users/closek/Documents/Nov2021_PalaueDNA/R/products/nearshore_esv_sp.csv")
```


##Unique nearshore species
```{r}
ns_esv <- nearshore_esv[rowSums(nearshore_esv==0, na.rm=TRUE)<ncol(nearshore_esv), ]
nearshore_esv[rowSums(nearshore_esv[])>0,]
n_distinct(nearshore_esv$Species)
unique(nearshore_esv$Species)

nearshore_esv_sp_wo0 <- read.csv(here("products/nearshore_esv_sp_wo0.csv"),header = TRUE)
unique(nearshore_esv_sp_wo0$Species)
n_distinct(nearshore_esv_sp_wo0$Species)
```


##Unique offshore species
```{r}
n_distinct(offshore_esv$Species)
unique(offshore_esv$Species)

offshore_esv_sp_wo0 <- read.csv(here("products/offshore_esv_sp_wo0.csv"),header = TRUE)
unique(offshore_esv_sp_wo0$Species)
n_distinct(offshore_esv_sp_wo0$Species)
```


##Unique species Nearshore & Offshore
```{r}
n_distinct(esv_read_data$Species)
```


##Unique species
```{r}
esv_list <- read.csv(here("data/JVB1710-MiFishU-esv-data.csv"),header = TRUE)
glimpse(esv_list)
str(esv_list)

n_distinct(esv_list$Species)
unique(esv_list$Species)
```

##Unique Genera
```{r}
n_distinct(esv_list$Genus)
unique(esv_list$Genus)

```

##Unique Families
```{r}
n_distinct(esv_list$Family)
unique(esv_list$Family)
unique
```


